# PowerShell profile extensions for dotfiles
# Source this file in your PowerShell profile:
#   . "$env:USERPROFILE\.config\powershell\profile.ps1"

# =============================================================================
# PSReadLine Configuration (Catppuccin Macchiato theme)
# =============================================================================
if (Get-Module -ListAvailable -Name PSReadLine) {
    # Catppuccin Macchiato palette
    $Macchiato = @{
        Rosewater = '#F4DBD6'
        Flamingo  = '#F0C6C6'
        Pink      = '#F5BDE6'
        Mauve     = '#C6A0F6'
        Red       = '#ED8796'
        Maroon    = '#EE99A0'
        Peach     = '#F5A97F'
        Yellow    = '#EED49F'
        Green     = '#A6DA95'
        Teal      = '#8BD5CA'
        Sky       = '#91D7E3'
        Sapphire  = '#7DC4E4'
        Blue      = '#8AADF4'
        Lavender  = '#B7BDF8'
        Text      = '#CAD3F5'
        Subtext1  = '#B8C0E0'
        Subtext0  = '#A5ADCB'
        Overlay2  = '#939AB7'
        Overlay1  = '#8087A2'
        Overlay0  = '#6E738D'
        Surface2  = '#5B6078'
        Surface1  = '#494D64'
        Surface0  = '#363A4F'
        Base      = '#24273A'
        Mantle    = '#1E2030'
        Crust     = '#181926'
    }

    Set-PSReadLineOption -Colors @{
        Command            = $Macchiato.Blue
        Comment            = $Macchiato.Overlay0
        ContinuationPrompt = $Macchiato.Teal
        Default            = $Macchiato.Text
        Emphasis           = $Macchiato.Red
        Error              = $Macchiato.Red
        InlinePrediction   = $Macchiato.Overlay0
        Keyword            = $Macchiato.Mauve
        ListPrediction     = $Macchiato.Mauve
        Member             = $Macchiato.Rosewater
        Number             = $Macchiato.Peach
        Operator           = $Macchiato.Sky
        Parameter          = $Macchiato.Pink
        Selection          = $Macchiato.Surface2
        String             = $Macchiato.Green
        Type               = $Macchiato.Yellow
        Variable           = $Macchiato.Lavender
    }

    # Better editing experience
    Set-PSReadLineOption -EditMode Emacs
    Set-PSReadLineOption -BellStyle None
    Set-PSReadLineOption -PredictionSource History
    Set-PSReadLineOption -PredictionViewStyle ListView
}

# =============================================================================
# PATH Configuration
# =============================================================================

# Add portable binaries to PATH (for portable mode without Scoop)
$LocalBin = Join-Path $env:USERPROFILE ".local\bin"
if (Test-Path $LocalBin) {
    if ($env:PATH -notlike "*$LocalBin*") {
        $env:PATH = "$LocalBin;$env:PATH"
    }
}

# Initialize starship prompt (if available)
if (Get-Command starship -ErrorAction SilentlyContinue) {
    $env:STARSHIP_CONFIG = Join-Path $env:USERPROFILE ".config\starship\config.toml"
    Invoke-Expression (&starship init powershell | Out-String)
}

# Initialize zoxide (if available)
if (Get-Command zoxide -ErrorAction SilentlyContinue) {
    Invoke-Expression (& zoxide init powershell | Out-String)
}

# Source dots.ps1 if it exists (dotfiles management functions)
$DotsScript = Join-Path $env:USERPROFILE ".config\powershell\dots.ps1"
if (Test-Path $DotsScript) {
    . $DotsScript
}

# =============================================================================
# Cross-shell portable functions (no external dependencies)
# =============================================================================

# Create missing $IsWindows if running PowerShell 5 or below
if (!(Test-Path variable:global:IsWindows)) {
    Set-Variable "IsWindows" -Scope "Global" -Value ([System.Environment]::OSVersion.Platform -eq "Win32NT")
}

# Navigation: Go up directories
function .. { Set-Location .. }
function ... { Set-Location ../.. }
function .... { Set-Location ../../.. }
function ..... { Set-Location ../../../.. }

# Navigation: Go to last directory
function cd- { Set-Location - }

# Directory listing
function l { Get-ChildItem -Force @args }
function ll { Get-ChildItem -Force @args }
function lsd { Get-ChildItem -Directory @args }
function lsh { Get-ChildItem -Hidden @args }

# File management
function mkcd {
    param([string]$Path)
    if (!(Test-Path $Path)) { New-Item -ItemType Directory -Path $Path | Out-Null }
    Set-Location $Path
}
Set-Alias -Name "take" -Value mkcd

function touch {
    param([string]$File)
    if (Test-Path $File) { (Get-Item $File).LastWriteTime = Get-Date }
    else { New-Item -ItemType File $File | Out-Null }
}

function ff { Get-ChildItem -Path . -File -Recurse -Name -Include @args }
function fd { Get-ChildItem -Path . -Directory -Recurse -Name -Include @args }

# General
function c { Clear-Host }
function reload { & $SHELL }
function path { $env:PATH -split ';' }
function which { param([string]$cmd) Get-Command $cmd -ErrorAction SilentlyContinue }

# Time (ISO-8601)
function now { Get-Date -Format "yyyy-MM-ddTHH:mm:ss" }
function unow { (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss") }
function nowdate { Get-Date -Format "yyyy-MM-dd" }
function nowtime { Get-Date -Format "HH:mm:ss" }
function timestamp { [int][double]::Parse((Get-Date -UFormat %s)) }
function week { (Get-Date -UFormat %Y-W) + (Get-Date -UFormat %W).PadLeft(2,'0') }
function weekday { Get-Date -UFormat %u }

# Networking
function localip {
    if ($IsWindows) {
        (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.PrefixOrigin -eq "Dhcp" -or $_.PrefixOrigin -eq "Manual" } | Select-Object -First 1).IPAddress
    } else { ipconfig getifaddr en0 }
}
function publicip { (Invoke-RestMethod http://ipinfo.io/json).ip }
function flushdns {
    if ($IsWindows) { ipconfig /flushdns }
    elseif ($IsMacOS) { dscacheutil -flushcache; sudo killall -HUP mDNSResponder }
    Write-Host "DNS cache flushed"
}

# Hash functions
function md5sum { param([string]$Path) Get-FileHash $Path -Algorithm MD5 }
function sha1sum { param([string]$Path) Get-FileHash $Path -Algorithm SHA1 }
function sha256sum { param([string]$Path) Get-FileHash $Path -Algorithm SHA256 }

# Weather
function weather { (Invoke-WebRequest -Uri "https://wttr.in/?format=%l:+(%C)+%c++%t+[%h,+%w]" -UserAgent "curl" -UseBasicParsing -TimeoutSec 10).Content }
function forecast { (Invoke-WebRequest -Uri "https://wttr.in?F" -UserAgent "curl" -UseBasicParsing -TimeoutSec 10).Content }

# Common paths
function dls { Set-Location (Join-Path $HOME "Downloads") }
function docs { Set-Location (Join-Path $HOME "Documents") }
function dt { Set-Location (Join-Path $HOME "Desktop") }
function repos { Set-Location (Join-Path $HOME "Code") }

# Clipboard
function cbpaste { Get-Clipboard }

# Development
function g { git @args }
function dk { docker @args }
function dco { docker-compose @args }
function va {
    $paths = @("./.venv/Scripts/Activate.ps1", "./venv/Scripts/Activate.ps1", "./.venv/bin/Activate.ps1", "./venv/bin/Activate.ps1")
    foreach ($p in $paths) { if (Test-Path $p) { . $p; break } }
}
function ve {
    if (Get-Command uv -ErrorAction SilentlyContinue) { uv venv }
    else { python -m venv .venv }
}
