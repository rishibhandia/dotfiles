{{- if or (eq .chezmoi.os "darwin") (eq .chezmoi.os "linux") -}}
#!/bin/bash
# Install packages from Brewfile
# This runs whenever the Brewfile changes
# Brewfile hash: {{ include "dot_Brewfile" | sha256sum }}

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { printf "${BLUE}[INFO]${NC} %s\n" "$1"; }
success() { printf "${GREEN}[OK]${NC} %s\n" "$1"; }
warn() { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }

# Ensure Homebrew is in PATH
{{- if eq .chezmoi.os "darwin" }}
{{-   if eq .chezmoi.arch "arm64" }}
eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || true
{{-   else }}
eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
{{-   end }}
{{- else }}
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" 2>/dev/null || true
{{- end }}

# Check if brew is available
if ! command -v brew &>/dev/null; then
    warn "Homebrew not found. Skipping package installation."
    exit 0
fi

BREWFILE="{{ .chezmoi.sourceDir }}/dot_Brewfile"

if [ ! -f "$BREWFILE" ]; then
    warn "Brewfile not found at $BREWFILE"
    exit 0
fi

info "Installing packages from Brewfile..."

# Run brew bundle
if brew bundle --file="$BREWFILE" --no-lock; then
    success "Packages installed successfully"
else
    warn "Some packages may have failed to install. Check output above."
fi

# Cleanup old versions
info "Cleaning up old versions..."
brew cleanup --prune=all 2>/dev/null || true

success "Package installation complete"
{{ end -}}
