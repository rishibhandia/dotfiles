{{- if not .ephemeral -}}
#!/bin/bash
# Set up Claude Code skills marketplace
# This runs once to register the anthropics/skills marketplace

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { printf "${BLUE}[INFO]${NC} %s\n" "$1"; }
success() { printf "${GREEN}[OK]${NC} %s\n" "$1"; }
warn() { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }

CLAUDE_DIR="$HOME/.claude"
PLUGINS_DIR="$CLAUDE_DIR/plugins"
MARKETPLACES_DIR="$PLUGINS_DIR/marketplaces"
SKILLS_REPO="anthropics/skills"
SKILLS_DIR="$MARKETPLACES_DIR/skills"

# Check if Claude Code is set up
if [[ ! -d "$CLAUDE_DIR" ]]; then
    info "Claude Code not initialized yet. Skipping skills setup."
    info "Run 'claude' first, then re-run 'chezmoi apply' to set up skills."
    exit 0
fi

# Ensure directories exist
mkdir -p "$MARKETPLACES_DIR"

# Clone or update the skills repo
if [[ -d "$SKILLS_DIR" ]]; then
    info "Updating skills marketplace..."
    git -C "$SKILLS_DIR" pull --quiet 2>/dev/null || warn "Could not update skills repo"
    success "Skills marketplace updated"
else
    info "Cloning skills marketplace from $SKILLS_REPO..."
    if git clone --quiet "https://github.com/$SKILLS_REPO.git" "$SKILLS_DIR" 2>/dev/null; then
        success "Skills marketplace cloned"
    else
        warn "Could not clone skills repo. Check internet connection."
        exit 0
    fi
fi

# Update known_marketplaces.json
KNOWN_MARKETPLACES="$PLUGINS_DIR/known_marketplaces.json"

if [[ -f "$KNOWN_MARKETPLACES" ]]; then
    # Check if skills marketplace is already registered
    if grep -q '"skills"' "$KNOWN_MARKETPLACES" 2>/dev/null; then
        success "Skills marketplace already registered"
    else
        info "Registering skills marketplace..."
        # Use jq if available, otherwise use a simple approach
        if command -v jq &>/dev/null; then
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
            jq --arg dir "$SKILLS_DIR" --arg ts "$TIMESTAMP" \
                '. + {"skills": {"source": {"source": "github", "repo": "anthropics/skills"}, "installLocation": $dir, "lastUpdated": $ts}}' \
                "$KNOWN_MARKETPLACES" > "$KNOWN_MARKETPLACES.tmp" && \
                mv "$KNOWN_MARKETPLACES.tmp" "$KNOWN_MARKETPLACES"
            success "Skills marketplace registered"
        else
            warn "jq not found. Please register marketplace manually in Claude Code:"
            warn "  /plugin marketplace add anthropics/skills"
        fi
    fi
else
    info "Creating known_marketplaces.json..."
    TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
    cat > "$KNOWN_MARKETPLACES" << EOF
{
  "skills": {
    "source": {
      "source": "github",
      "repo": "anthropics/skills"
    },
    "installLocation": "$SKILLS_DIR",
    "lastUpdated": "$TIMESTAMP"
  }
}
EOF
    success "Skills marketplace registered"
fi

# Print instructions for installing skills
echo ""
info "Skills marketplace is ready! Install skills in Claude Code with:"
echo ""
echo "  /install pdf"
echo "  /install xlsx"
echo "  /install pptx"
echo "  /install docx"
echo "  /install theme-factory"
echo "  /install doc-coauthoring"
echo "  /install internal-comms"
echo "  /install slack-gif-creator"
echo ""
success "Claude Code skills setup complete"
{{ end -}}
